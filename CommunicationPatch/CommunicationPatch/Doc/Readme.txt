/*******************************************************************************
//Copyright(C)2018 , 蛙鸣公司
// All rights reserved.
// Version: v1.0
// Device : STM32F103C8T6
// Built  : IAR For ARM v7.70(Language: C)
// Date   : 2018-10-27
// Author : 刘锋
// Functiom:APP应用程序的工程说明文档，记录程序进度
*******************************************************************************/




20181224:
1、解决了数据补传过程中断网了之后不存储数据的问题，是由于有数据包待补发的标志未清零（之前只有在传输完了之后才清零）；
2、优化了无线模块端接收服务器数据包时的判断接收完毕的超时时间为50ms；
3、优化了断网后存储到片外Flash时的最大页码判断，修改为4050整扇区；



20181223:
1、解决了断网存储和重新联网后出现的补传重包和计时偏差问题，是由于补传时又有数据要发送、传感器数据获取等待导致的；



20181222:
1、优化了断网存储和重新联网后的补传功能；



20181221:
1、优化了断网后由于去配置无线模块耽误了准确计时导致传感器数据存储大于1分钟的问题；



20181219:
1、解决了无线模块配置过程中进入“失效网络”+“配置网络”的死循环问题；
2、增加了在发送传感器数据后10s超时后没有接收到应答数据包也将传感器数据包存储到外部Flash的功能；



20181214:
1、解决了“断网情况下，恢复网络后，数据没有进行补传”的问题;



20181213:
1、优化了无线模块重新配置时间慢的现象，缩短了时间；
2、提高了下发Debug的效率；
3、解决了“断网情况下，恢复网络后，数据没有进行补传”的问题


20181205:
1、所有功能完成。


20181202:
1、解决了片外Flash写入函数中由于开辟的4096byte数组太大超过堆栈可开辟空间的问题；


20181130:
1、增加了Debug口透传数据给设备的功能，用于配置设备参数；
2、修改扇区擦除时地址为该扇区首地址的问题；



20181130:
1、优化了读取设备端的传感器数据的程序，增加了对传感器类型的判断，以控制过滤掉没有接入的传感器数据；


20181129:
1、优化了数据存储和读取发送的程序，解决了发送的数据不对的问题；
2、增加了对设备端上报的传感器是否有该类型传感器数据的状态判断；


20181127:
1、解决了IP地址读取错误的问题，是因为IP地址的读取没有“\r\n”；
2、解决了其它命令下发后响应错误的问题；


20181127:
1、解决了数据包的RTC时间不变的问题；


20181126:
1、实现了断网后将传感器数据存储到片外Flash芯片W25Q128中，并且为了恢复后发生给服务器的功能；


20181125:
1、实现了断网后将传感器数据存储到片外Flash芯片W25Q128中，待网络恢复后将所有存储的数据包上传服务器的功能，待测试；


20181125:
1、增加了片外Flash芯片W25Q128的读写功能，待规划好具体的存储空间；


20181124:
1、解决了设备编号错误的问题；
2、增加了读取设备电源电压的功能；
3、优化了读取传感器数据的程序；
4、完成了基本功能，包括初始化无线模块、初始化设备、读取传感器数据、上传传感器数据等主要功能；
5、还差服务器端的下发设置未调试，以及Flash存储；
6、备注：先读取传感器数据，得到后立刻关闭传感器数据显示，然后再打开电源电压显示，得到后立刻关闭；


20181116:
1、解决了传感器数据上报不能显示在网页的问题，原因是传感器个数错误；


20181112:
1、完成了启动时读取设备编号和GPS信息的程序；
2、完成了启动时读取心跳包和通用数据上报间隔；
3、增加了启动时读取电池电压的程序，待验证；


20181111:
1、完成发送、接收及处理与设备端通信的程序，能发送控制显示若干打印、重启、传感器数据接收解析等功能；


20181110:
1、完成接收服务器数据包的解析及处理程序，能发送握手包给服务器，而且能正常接收、处理服务器发来的时间同步和通用应答包；

20181108:
1、完成无线模块所有的AT指令操作程序，待验证、测试和修改；

20181106:
1、开始编写无线模块的AT指令操作程序；


20181103:
1、开始编写与服务器通信的程序；


20181028:
1、完成DEBUG口的通信程序；


20181027:
1、建立工程；
//////////////////////////////////////////////////////////////////////
与设备端通信的工作流程：
1、上电复位一次设备；
2、等待接收设备端打印的各个传感器状态信息；
3、等待接收传感器采集开始的打印信息（表示启动完毕）；
4、打开GPS打印信息，得到后关闭；
5、间隔若干时间打开传感器信息打印，即"$SHOW_DATA"，得到后关闭
6、




设备重启后打印：
[RTC]: Software reset occurred....

[RTC]: No need to configure RTC....

------<SYSTEM START>-----
[Init]: FLASH......(ok)!
[Init]: GAS........(ok)(4)!
[Init]: RS485......(ok)!
[Init]: WK2114.....(ok)!
[Init]: ADS1248....(ok)!
[Init]: NET........(ok)!
[Init]: GSM........(checking)!
[Init]: TRH........(ok)(1)!
[Init]: GPS........(ok)!
[Init]: Weather....(ok)!
[Init]: PM2.5......(ok)!
[Init]: CO2........(error)!
[EVENT]: Sampling start!


Q_ID=80003165
Q_DATARPT=60,300(OK!)
Q_HEALTHRPT=180(OK!)

[ADC]: VBat=2759/1522V


struct tm {
int tm_sec; /* 秒 C 取值区间为[0,59] */
int tm_min; /* 分 - 取值区间为[0,59] */
int tm_hour; /* 时 - 取值区间为[0,23] */
int tm_mday; /* 一个月中的日期 - 取值区间为[1,31] */
int tm_mon; /* 月份（从一月开始，0代表一月） - 取值区间为[0,11] */
int tm_year; /* 年份，其值等于实际年份减去1900 */
int tm_wday; /* 星期 C 取值区间为[0,6]，其中0代表星期天，1代表星期一，以此类推 */
int tm_yday; /* 从每年的1月1日开始的天数 C 取值区间为[0,365]，其中0代表1月1日，1代表1月2日，以此类推 */
int tm_isdst; /* 夏令时标识符，实行夏令时的时候，tm_isdst为正。不实行夏令时的进候，tm_isdst为0；不了解情况时，tm_isdst()为负。*/
};

/*
******************************************************************************
* Function Name  : SSInfoPrint()
* Description    : 传感器信息输出格式
* Input          :
* Output         : None
* Return         : None
//左对齐输出
******************************************************************************
*/
static	void	SSInfoPrint (void)
{
//接了外部传感器：
[SS-Temp  ]=2236
[SS-RH    ]=7075
[SS-PM2.5 ]=9000,3006,5039
[SS-PM10  ]=12000,7120,12104
[SS-CO(3) ]=54183,3010342,1270803
[SS-NO2(4)]=1846,4702,80053
[SS-O3(5) ]=13190,-56089,104090
[SS-SO2(6)]=167870,264521,4639
[SS-NO(7) ]=0,0,0
[SS-Temp-W]=2480
[SS-RH-W  ]=6240
[SS-WD    ]=20700
[SS-WS    ]=0
[SS-PA    ]=101950
[FUN-main ]=0/min
[FUN-pm10 ]=0/min
2018-9-28	4:39:22

//未接外部传感器：
[SS-Temp  ]=2172
[SS-RH    ]=6717
[SS-PM2.5 ]=94000,32504,54477
[SS-PM10  ]=0,0,0
[SS-CO(3) ]=175247,9736138,3288541
[SS-NO2(4)]=2981,7562,84343
[SS-O3(5) ]=-13512,-150463,-745276
[SS-SO2(6)]=0,16998,-9221
[SS-NO(7) ]=0,0,0
[FUN-main ]=0/min
[FUN-pm10 ]=0/min
2018-10-6	13:44:16
}

/*
******************************************************************************
* Function Name  : GPSInfoPrint()
* Description    : GPS信息输出
* Input          :
* Output         : None
* Return         : None
//左对齐
******************************************************************************
*/
static	void	GPSInfoPrint (void)
{
$GPGGA,235947.020,,,,,0,0,,,M,,M,,*44
$GPGLL,,,,,235947.020,V,N*76
$GPGSA,A,1,,,,,,,,,,,,,,,*1E
$GPGSV,1,1,00*79
$GPRMC,235947.020,V,,,,,0.00,0.00,050180,,,N*4D
$GPVTG,0.00,T,,M,0.00,N,0.00,K,N*32
}




//////////////////////////////////////////////////////////////////////
// 系统应用参数区-默认参数定义
#define	DEF_DFT_SYSCFG_SAVED_MARK			((u16)0x66AA)				// 系统应用参数区初始化完成标志((默0x66AA,修改后参数将复位)
#define	DEF_DFT_SYSCFG_SUM						((u16)0x0000)			// 需要根据具体参数计算!!!!
#define	DEF_DFT_SYSCFG_AESTYPE				((u8)0x00)					// 加密类型
#define	DEF_DFT_SYSCFG_AESKEY					("")					// 秘钥
#define	DEF_DFT_SYSCFG_APN						("")					// 系统APN
#define	DEF_DFT_SYSCFG_APNUSER				("")						// 系统APN登陆用户
#define	DEF_DFT_SYSCFG_APNPASS				("")						// 系统APN登陆密码
#define	DEF_DFT_SYSCFG_DOMAINEN				((u8)0)                     // 域名连接使能如果为1则使能域名连接为0则禁止域名连接即IP连接
#define	DEF_DFT_SYSCFG_DNSIP					("202.106.0.20")		// 系统域名服务器IP地址
#define	DEF_DFT_SYSCFG_DOMAIN1				("null1")					// 系统域名1
#define	DEF_DFT_SYSCFG_DOMAIN2				("null2")					// 系统域名2
#define	DEF_DFT_SYSCFG_IP1						("58.83.189.147")		// 系统主服务器IP地址(主IP)
#define	DEF_DFT_SYSCFG_PORT1					("21009")				// 系统主服务器端口号
#define	DEF_DFT_SYSCFG_IP2						("58.83.189.147")		// 系统辅助服务器IP地址(辅助IP)
#define	DEF_DFT_SYSCFG_PORT2					("21009")				// 系统辅助服务器端口号
#define	DEF_DFT_SYSCFG_NATIONCODE			("86")						// 国家代码(中国默认"86")使用PDU方式发送短信时使用
#define	DEF_DFT_SYSCFG_SMSCENTER			("")						// 监控平台SMS猫电话号码



以下功能为必须实现功能。
?	支持传感器远程校准（k1、b1等）。
?	支持数据上传。
?	支持GPS定位。
?	握手指令（0x80）。
?	设置和查询系统RTC时间。
?	设置IP地址。
?	设置和查询通用数据上传间隔。
?	设置和查询健康包上传时间间隔。
?	设备复位指令。








//////////////////////////////C文件/////////////////////////////////////
/*******************************************************************************
//XXX.c
//XXX驱动文件
*******************************************************************************/

/******************************************************************************
//包含头文件
*******************************************************************************/
#include "stm32l1xx.h"
#include "system_stm32l1xx.h"
#include "stm32l1xx_conf.h"
#include "XXX/XXX.h"

/******************************************************************************
//变量定义
*******************************************************************************/


/******************************************************************************
//函数定义
*******************************************************************************/



//////////////////////////////END OF C文件////////////////////////////////////


//////////////////////////////头文件/////////////////////////////////////
/*******************************************************************************
//XXX.h
//XXX驱动头文件
*******************************************************************************/

#ifndef	XXX_H
#define	XXX_H

/******************************************************************************
//宏定义
*******************************************************************************/

